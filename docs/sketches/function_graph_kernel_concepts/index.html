<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>FGK Sketch Concepts - VirtualDataSet</title>
    <meta name="generator" content="Hugo 0.31" />

    
    <meta name="description" content="VirtualDataSet Docs">
    
    <link rel="canonical" href="http://docs.virtdata.io/sketches/function_graph_kernel_concepts/">
    

    <meta property="og:url" content="http://docs.virtdata.io/sketches/function_graph_kernel_concepts/">
    <meta property="og:title" content="VirtualDataSet">
    <meta property="og:image" content="http://docs.virtdata.io/images/virtdata_128.png">
    <meta name="apple-mobile-web-app-title" content="VirtualDataSet">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="http://docs.virtdata.io/images/engineblock_32.png">
    <link rel="icon" type="image/x-icon" href="http://docs.virtdata.io/images/engineblock_32.png">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('http://docs.virtdata.io/fonts/icon.eot');
        src: url('http://docs.virtdata.io/fonts/icon.eot')
               format('embedded-opentype'),
             url('http://docs.virtdata.io/fonts/icon.woff')
               format('woff'),
             url('http://docs.virtdata.io/fonts/icon.ttf')
               format('truetype'),
             url('http://docs.virtdata.io/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="http://docs.virtdata.io/stylesheets/application.css">
    <link rel="stylesheet" href="http://docs.virtdata.io/stylesheets/temporary.css">
    <link rel="stylesheet" href="http://docs.virtdata.io/stylesheets/palettes.css">
    <link rel="stylesheet" href="http://docs.virtdata.io/stylesheets/images.css">

    <link rel="stylesheet" href="http://docs.virtdata.io/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto&#43;Mono">
    <style>
      body, input {
        font-family: 'Roboto', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="http://docs.virtdata.io/javascripts/modernizr.js"></script>

    

  
    
    

    
    
    <script src="http://docs.virtdata.io//modules/viz/viz.js"></script>
    

    
    

    
    

    
    

    
    

    
    
    
    
    

    
    


      
    
    <link href="http://docs.virtdata.io//modules/annotatorjs/annotator.css" rel="stylesheet" />
    <script src="http://docs.virtdata.io//modules/annotatorjs/jquery-3.2.1.js"></script>
    <script src="http://docs.virtdata.io//modules/annotatorjs/annotator.js"></script>
    <script>
        var app = new annotator.App();
        app.include(annotator.ui.main);
        app
            .start()
            .then(function() {
                app.annotations.load();
            });
    </script>


  </head>
  <body class="palette-primary-grey palette-accent-teal">




<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        FGK Sketch Concepts
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/virtualdataset/metagen-java" title="@virtualdataset/metagen-java on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="http://docs.virtdata.io/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="http://docs.virtdata.io/images/virtdata_128.png">
        </div>
      
      <div class="name">
        <strong>VirtualDataSet </strong>
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      

      <div class="toc">
        
        <ul>
          




<li>
  
    <span class="section">Introduction</span>
    <ul>
      
        
        



<a  title="Why VirtData?" href="http://docs.virtdata.io/why_virtdata/why_virtdata/">
	
	Why VirtData?
</a>



      
    </ul>
  
</li>



<li>
  
    <span class="section">Concepts</span>
    <ul>
      
        
        



<a  title="Mapping Functions" href="http://docs.virtdata.io/concepts/mapping_functions/">
	
	Mapping Functions
</a>



      
        
        



<a  title="Function Graphs" href="http://docs.virtdata.io/concepts/function_graphs/">
	
	Function Graphs
</a>



      
    </ul>
  
</li>



<li>
  
    <span class="section">Modeling Datasets</span>
    <ul>
      
        
        



<a  title="Cardinality" href="http://docs.virtdata.io/modeling_datasets/modeling_cardinality/">
	
	Cardinality
</a>



      
        
        



<a  title="Set Relationships" href="http://docs.virtdata.io/modeling_datasets/set_relationships/">
	
	Set Relationships
</a>



      
    </ul>
  
</li>



<li>
  
    



<a  title="Glossary" href="http://docs.virtdata.io/glossary">
	
	Glossary
</a>



  
</li>


        </ul>
        

        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>FGK Sketch Concepts </h1>

			

<h2 id="description">Description</h2>

<p>This section elaborates on the function graph kernel design.</p>

<p>Herein, the function graph kernel will be abbreviated as FGK, although it needs
a better name. In essence, the function graph kernel is a runtime implementation
of the <a href="../function_graph_kernel_api">Function Graph Kernel API</a>.</p>

<p>A function graph is a directed graph. No loops are currently supported.</p>

<p>Let us start with an example function graph template:</p>



<div align="center" class="viz-text"><pre>
digraph function_graph {
    size=&#34;4,4&#34;
    f1[label=&#34;f()&#34;,shape=&#34;ellipse&#34;];
    f2[label=&#34;g()&#34;,shape=&#34;ellipse&#34;];
    f3[label=&#34;h()&#34;,shape=&#34;ellipse&#34;];
    f4[label=&#34;i()&#34;,shape=&#34;ellipse&#34;];
    node[shape=&#34;box&#34;];
    var1,var2,var3,var4;
    var2 -&gt; f1 -&gt; f2 -&gt; var4;
    var1 -&gt; f1 -&gt; var3;
    var2 -&gt; f4 -&gt; var6;
    f1 -&gt; var5 -&gt; f3 -&gt; var3;
    subgraph cluster1 {
     label=&#34;inputs&#34;;
     var1,var2;
    }
    subgraph cluster2 {
     label=&#34;outputs&#34;;
     var3, var4, var6;
    }
}
</pre></div>
<script type="text/javascript" src="http://docs.virtdata.io/modules/viz/inithook-viz.js"></script>


<p>This is a basic model of a function graph without the usual data types and
meaningful names. The purpose of this is to illustrate that a function graph
can have the following:</p>

<ol>
<li>Named fields which have no upstream inputs. These are <em>coordinate fields</em>.</li>
<li>Unary functions, such as <code>i(var2)-&gt;var6</code></li>
<li>bi-functions, as in <code>f(var1,var2) -&gt; var3</code></li>
<li>overlapping lambda paths, as in both <code>f()</code> and <code>g()</code></li>
<li>independent flows, as in <code>i(var2) -&gt; var6</code></li>
<li>Intermediate fields as in <code>var5</code> connecting <code>f(var1,var2)-&gt;var5</code> and <code>h(var5)-&gt;var3</code>.</li>
<li>Named fields which have upstream inputs, which may be read or written to.</li>
</ol>

<p>However, the following is verboten:</p>

<ol>
<li>Loops are <strong>not</strong> allowed. A function graph is a directed graph. All paths back to the inputs must end up at coordinate fields.</li>
<li>Connections directly between fields are <strong>not</strong> allowed. A field is the holder for the result of a single function.</li>
<li>Fields which have more than one upstream function are <strong>not</strong> allowed. A field is the holder for result of a single function.</li>
</ol>

<h2 id="usage-semantics">Usage Semantics</h2>

<p>However, there are limited ways to interact with the function graph. The
designer of the function graph determines what the available inputs and outputs
are, and gives them names to suit.</p>

<p>All interactions with a user should be based on named inputs and outputs. These
are referred to as <strong>fields</strong> in the FGK. In the naive implementation, all
fields are simple state boxes which can be muted or observed via the named-based
getter and setter API.</p>

<p>In this example, we will assume that all fields are meant to be
interacted with. Any field that does not have an inbound path on the graph
will be deemed an independent variable, and thus a coordinate. Any other
field will be deemed visible, but also settable by the application.</p>

<p>Further, the fields have strict types. This is necessary in order to make an
efficient FGK implementation as well as to handle type-conversion robustly.</p>

<h2 id="dependency-tracking">Dependency Tracking</h2>

<p>One of the goals of the FGK design is to allow for localized computation of
subgraphs which are relatively high-use without incurring the cost of
recomputing all predecessor values. This means that it is necessary to identify,
based on the data flow through the graph, when an observable value has become
stale with respect to its upstream inputs &ndash; possibly back to the original
coordinate inputs. There are various ways to approach this.</p>

<h2 id="dependency-structure">Dependency Structure</h2>

<p>Each field in a graph has a distinct pathway of dependencies. Specifically, the
set of dependencies is the directed graph that results from tracing a field to
its inputs, repeating the process for each of them, and so forth, until the
independent variables (also known as <em>coordinate fields</em>) are found. Perhaps,
counter-intuitively, the dependencies for a given field must include the actual
data-flow segments between it and any predecessor fields as well as the
functions along the path between them. This means that each field has a proper
graph that describes its dependencies.</p>

<p>However, this is the full dependency graph. We are generally more interested in
breaking the over-all function graph down to segments which can be used to
determine when a field&rsquo;s value goes stale with respect to its inputs.</p>

<p>Further, the grain of data depends on the possible mutations within the graph.
Since we are limiting user interactions only to the named fields, the
possible mutations are mechanically the paths between the fields, including
any function chains along the way.</p>

<p>Taking all this into account gives us a canonical recipe for the state tracking
model for a function graph kernel: A simple deterministic ordering of all
dependency segments for each field which indexes into a bitmask for change
status. Each bit in the bitmask represents TBD</p>

<p>A kernel-global register tracks when a field is stale with respect to all of its
inputs. This register is specifically named the <em>dependency tracking register</em>.
This register is considered unsigned, providing for up to 64 independent
segments tracked per kernel for the naive implementation.</p>

<p>Further, each field has its own mask of bits, called the <em>dependency
mask</em> that determines which of the global tracking register segments feed into
it.</p>

<p>If there are fields which are not meant to be exposed to the getter/setter API,
then these can be elided and the enclosing segments tracked as a single segment.</p>

<p>Consider the following function graph:</p>



<div align="center" class="viz-text"><pre>
digraph tracking {
    size=&#34;4,4&#34;
    seed[label=&#34;seed: long&#34;]
    cycle[label=&#34;cycle: long&#34;]
    user_id[label=&#34;user_id: long&#34;]
    seed -&gt; U -&gt; user_id [color=&#34;grey&#34;, label=&#34;0&#34;,labelcolor=&#34;grey&#34;];
    cycle-&gt; U -&gt; user_id [color=&#34;blue&#34;,label=&#34;1&#34;,labelcolor=&#34;blue&#34;];
    user_id -&gt; F -&gt; first_name [color=&#34;red&#34;, label=&#34;2&#34;, labelcolor=&#34;red&#34;];
    user_id -&gt; L -&gt; last_name [color=&#34;green&#34; label=&#34;3&#34;, labelcolor=&#34;green&#34;];
  tracker[shape=&#34;record&#34;, label=&#34;{dependency tracking register|{0|1|2|3|...}}&#34;]
}
</pre></div>
<script type="text/javascript" src="http://docs.virtdata.io/modules/viz/inithook-viz.js"></script>


<p>The dependency masks implied are: (msb first)</p>

<pre><code>user_id is  0011  # 1&lt;&lt;0, 1&lt;&lt;1
last_name   1011  # 1&lt;&lt;0,       1&lt;&lt;2, 1&lt;&lt;4
first_name  0111  # 1&lt;&lt;0, 1&lt;&lt;1, 1&lt;&lt;2
</code></pre>

<p>With the masks attached to their associated variables:</p>



<div align="center" class="viz-text"><pre>
digraph tracking {
    size=&#34;4,4&#34;
    seed[label=&#34;seed: long&#34;,shape=&#34;box&#34;]
    cycle[label=&#34;cycle: long&#34;,shape=&#34;box&#34;]
    user_id[label=&#34;user_id: long&#34;,shape=&#34;box&#34;]
    first_name[label=&#34;first_name: String&#34;,shape=&#34;box&#34;]
    last_name[label=&#34;last_name: String&#34;,shape=&#34;box&#34;]
    seed -&gt; U -&gt; user_id [color=&#34;grey&#34;, label=&#34;0&#34;,labelcolor=&#34;grey&#34;];
    cycle-&gt; U -&gt; user_id [color=&#34;blue&#34;,label=&#34;1&#34;,labelcolor=&#34;blue&#34;];
    user_id -&gt; F -&gt; first_name [color=&#34;red&#34;, label=&#34;2&#34;, labelcolor=&#34;red&#34;];
    user_id -&gt; L -&gt; last_name [color=&#34;green&#34; label=&#34;3&#34;, labelcolor=&#34;green&#34;];
    seed_mask[shape=&#34;record&#34;, label=&#34;mask|0b0000&#34;, fontcolor=&#34;blue&#34;,color=&#34;blue&#34;];
    cycle_mask[shape=&#34;record&#34;, label=&#34;mask|0b0000&#34;, fontcolor=&#34;blue&#34;,color=&#34;blue&#34;];
    first_name_mask[shape=&#34;record&#34;, label=&#34;mask|0b0111&#34;, fontcolor=&#34;blue&#34;,color=&#34;blue&#34;];
    last_name_mask[shape=&#34;record&#34;, label=&#34;mask|0b1011&#34;, fontcolor=&#34;blue&#34;,color=&#34;blue&#34;];
    user_id_mask[shape=&#34;record&#34;, label=&#34;mask|0b0011&#34;, fontcolor=&#34;blue&#34;,color=&#34;blue&#34;];
    seed-&gt;seed_mask;
    cycle-&gt;cycle_mask;
    user_id-&gt;user_id_mask;
    first_name-&gt;first_name_mask;
    last_name-&gt;last_name_mask;
}
</pre></div>
<script type="text/javascript" src="http://docs.virtdata.io/modules/viz/inithook-viz.js"></script>


<h2 id="design-invariants">Design Invariants</h2>

<p>Certain behaviors will need to be encoded as standard for the purposes of API
simplicity:</p>

<ul>
<li>The function graph segments referenced in the <em>dependency tracking register</em>
should be ordered so that upstream segments always occur before their respective
downstream segments.</li>
<li>A given FGK should be initialized with all output fields current with respect
to the default coordinates. This also serves as a runtime validation of the
kernel.</li>
<li>When an input coordinate is set to the same value as it was previously set to,
the FGK should disregard setting any flags for field invalidation.</li>
</ul>

<h2 id="using-dependency-data">Using Dependency Data</h2>

<p>The above graph shows both the effect of tracking change flow for unary functions as well
as an implied bi-function. If either the <em>seed</em> or the <em>cycle</em> value are changed, then
one of the inbound paths to <em>user_id</em> is affected. Further, it is specific which one is
affected, although in the case of a bi-function, both inputs must be used again for
re-computation.</p>

<p>The basic rules of state tracking using this dependency scheme are as follows:</p>

<ol>
<li>When a field is observed, the logical and of its <em>dependency mask</em> and the
<em>dependency tracking register</em> is computed. The resulting bitfield is the
execution plan for which variables to compute. All of indicated segments are
computed in order, and then the global tracking register is unset for those
segments.</li>
<li>The resulting field(s) are returned.</li>
</ol>

<p>This means that computing the required executions for a single readable variable
is akin to computing them for multiple fields. The only difference is that for multiple
variables, the logical or of all dependency masks is taken first. This can allow for
iterative calls to a kernel to be coalesced if the fields sets are known ahead of time.</p>

<h2 id="optimizations">Optimizations</h2>

<p>With the model above, it becomes possible to create a caching layer around named
fields that enable direct invocation of sections of the graph without the cost
of name-based lookup.</p>

<p>Example pseudo-code:</p>

<pre><code>mut= fgk.prepareMutator(new String[]{ &quot;var1&quot;, &quot;var2&quot;}, new String[]{&quot;var5,var6&quot;});
Object[] outs=mut.call(&quot;a&quot;,&quot;b&quot;);
</code></pre>

<p>While not proper code, this illustrates the idea of knowing which set of inputs will
be used with a set of outputs and thus allowing for the <em>pre-baking</em> of the call-sites
for better performance.</p>


			<aside class="copyright" role="note">
				
				&copy; 2018 APL 2.0 &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="http://docs.virtdata.io/sketches/function_graph_kernel_scratch/" title="FGK Implementation Ideas">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              FGK Implementation Ideas
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="http://docs.virtdata.io/sketches/function_graph_kernel_primitives/" title="FGK Sketch Primitives">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              FGK Sketch Primitives
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = '';
      var repo_id  = '';
    
    </script>

    <script src="http://docs.virtdata.io/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "Â¶";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

